#!/usr/bin/env python

import numpy as np
from random import randint
from operator import itemgetter

import  sys
CAFFE_HOME = '/home/msprj_security/010775479/caffe/'
CUDA_HOME='/usr/local/cuda'
sys.path.insert(0,CAFFE_HOME+'python')

import matplotlib 
matplotlib.use('Agg')

import caffe

png_file_name=sys.argv[1];

MODEL_FILE = '/home/msprj_security/010775479/caffe/examples/cmpe/malware.prototxt'
PRETRAINED = '/home/msprj_security/010775479/caffe/examples/cmpe/malware_iter_40000_Andro.caffemodel'
LABEL_FILE = '/home/msprj_security/010775479/caffe/examples/cmpe/train.txt'
MALICIOUS_LABEL_FILE = '/home/msprj_security/010775479/caffe/examples/cmpe/maliciousinfo.txt'

#print(png_file_name)
caffe.set_mode_cpu()

#img = caffe.io.load_image('/home/msprj_security/pngfile/input_image.png', color=False)
img = caffe.io.load_image('/home/msprj_security/pngfile/'+png_file_name+'.png' , color=False)
img = img.astype(np.uint8)
net=caffe.Classifier(MODEL_FILE, PRETRAINED, image_dims=(120,120), raw_scale=255)

log = open('/home/msprj_security/pngfile/caffe_output.txt','w')

#works
out = net.forward(data=np.asarray([img.transpose(2,0,1)]))
output_prob = out['prob'][0]
print >> log, "predicted class:", out['prob'].argmax()

if out['prob'].argmax() == 1:
        #Predict label
        fi = open(LABEL_FILE)
        labels = fi.readlines()

	val = randint(0,999)
        #print 'rand:', val
        new_labels = np.loadtxt(MALICIOUS_LABEL_FILE,str)
        #print 'output label:', new_labels[output_prob.argmax()]
        top_inds = output_prob.argsort()[::-1][:4]
        #print 'before:', top_inds
        top_inds = [val-x for x in top_inds]
        #print 'after:', top_inds 
        items = zip(output_prob[top_inds]*1000, new_labels[top_inds])
        #print 'items:', items
        print >> log, 'probabilities and labels:\n',items
        print >> log, 'output label:', max(items,key=itemgetter(0))


log.close()
